<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Adjust speed through water for strength of current">

<title>Current Correction (current) – pyseatrials</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ebc57992554dae5230fa85c1bd5a55fa.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="Current Correction (current) – pyseatrials">
<meta property="og:description" content="Adjust speed through water for strength of current">
<meta property="og:image" content="https://JonnoB.github.io/pyseatrials/06_current_files/figure-html/cell-3-output-1.png">
<meta property="og:site_name" content="pyseatrials">
<meta property="og:image:height" content="455">
<meta property="og:image:width" content="570">
<meta name="twitter:title" content="Current Correction (current) – pyseatrials">
<meta name="twitter:description" content="Adjust speed through water for strength of current">
<meta name="twitter:image" content="https://JonnoB.github.io/pyseatrials/06_current_files/figure-html/cell-3-output-1.png">
<meta name="twitter:image-height" content="455">
<meta name="twitter:image-width" content="570">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">pyseatrials</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./current.html">Current Correction (current)</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">pyseatrials</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./general_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">General Functions</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wind.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Evaluation of wind data (wind)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wave_resistance.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Wave Resistance (wave)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./power.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Direct Power Analysis (power)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./wind_resistance_coef.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Wind resistance coefficients (wind_res)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./current.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Current Correction (current)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./shallow_water.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Shallow water corrections (shallow)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./full_example.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Which ship is best?</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./trig.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Useful trigonometry (trig)</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./basic_hydro_functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic hydro functions (basic)</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#which-to-choose" id="toc-which-to-choose" class="nav-link active" data-scroll-target="#which-to-choose"><span class="header-section-number">1</span> Which to choose?</a></li>
  <li><a href="#iterative-method" id="toc-iterative-method" class="nav-link" data-scroll-target="#iterative-method"><span class="header-section-number">2</span> Iterative Method</a>
  <ul class="collapse">
  <li><a href="#step-1-estimate-the-speed-power-curve" id="toc-step-1-estimate-the-speed-power-curve" class="nav-link" data-scroll-target="#step-1-estimate-the-speed-power-curve"><span class="header-section-number">2.1</span> Step 1: Estimate the speed-power curve</a></li>
  <li><a href="#step-2-estimate-speed-through-water-from-observed-power-and-speed-power-model" id="toc-step-2-estimate-speed-through-water-from-observed-power-and-speed-power-model" class="nav-link" data-scroll-target="#step-2-estimate-speed-through-water-from-observed-power-and-speed-power-model"><span class="header-section-number">2.2</span> Step 2: Estimate speed through water from observed power and speed-power model</a></li>
  <li><a href="#step-3-estimate-current-and-current-coefficients" id="toc-step-3-estimate-current-and-current-coefficients" class="nav-link" data-scroll-target="#step-3-estimate-current-and-current-coefficients"><span class="header-section-number">2.3</span> Step 3: Estimate Current and current coefficients</a></li>
  <li><a href="#step-4-re-calculate-the-speed-power-curve-coefficients" id="toc-step-4-re-calculate-the-speed-power-curve-coefficients" class="nav-link" data-scroll-target="#step-4-re-calculate-the-speed-power-curve-coefficients"><span class="header-section-number">2.4</span> Step 4: Re-calculate the speed-power curve coefficients</a></li>
  <li><a href="#step-5-measure-the-error-between-the-observed-and-predicted-enginer-power" id="toc-step-5-measure-the-error-between-the-observed-and-predicted-enginer-power" class="nav-link" data-scroll-target="#step-5-measure-the-error-between-the-observed-and-predicted-enginer-power"><span class="header-section-number">2.5</span> Step 5: Measure the error between the observed and predicted Enginer power</a></li>
  <li><a href="#diagram" id="toc-diagram" class="nav-link" data-scroll-target="#diagram"><span class="header-section-number">2.6</span> Diagram</a></li>
  <li><a href="#note" id="toc-note" class="nav-link" data-scroll-target="#note"><span class="header-section-number">2.7</span> Note:</a></li>
  <li><a href="#estimate_speed_through_water" id="toc-estimate_speed_through_water" class="nav-link" data-scroll-target="#estimate_speed_through_water"><span class="header-section-number">2.8</span> estimate_speed_through_water</a></li>
  </ul></li>
  <li><a href="#mean-of-means-method" id="toc-mean-of-means-method" class="nav-link" data-scroll-target="#mean-of-means-method"><span class="header-section-number">3</span> Mean of means method</a>
  <ul class="collapse">
  <li><a href="#current_mean_of_means" id="toc-current_mean_of_means" class="nav-link" data-scroll-target="#current_mean_of_means"><span class="header-section-number">3.1</span> current_mean_of_means</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/JonnoB/pyseatrials/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Current Correction (current)</h1>
</div>

<div>
  <div class="description">
    Adjust speed through water for strength of current
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<p>This module represents the Appendix H of the ITTC, and provides the functionality to correct for current.</p>
<p>The current correction approaches can only really be used if the ITTC speed power process has been followed closely. The corrections require that there are multiple runs for several speed settings. This allows a regression to be made. If there is only one speed setting then the methods described in appendix H will not be applicable. If multiple double runs or runs at different speeds have not been performed then ship current sensors, met-ocean data, or other methods will have to be used.</p>
<section id="which-to-choose" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="which-to-choose"><span class="header-section-number">1</span> Which to choose?</h2>
<p>Although the two methods are not mutually exlusive, they do have different minimum data gathering requirements in order to be used.</p>
<ul>
<li>The iterative method can be used when the seatrial has performed a <strong>SINGLE</strong> set of double runs at <strong>DIFFERENT</strong> power settings</li>
<li>The Mean of Means method can be performed when there have been <strong>TWO</strong> sets of double-runs at the <strong>SAME</strong> power setting</li>
</ul>
</section>
<section id="iterative-method" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="iterative-method"><span class="header-section-number">2</span> Iterative Method</h2>
<p>The iterative method assumes a current that varies with a semidurational period. This period is typically 12 hours, 25 minutes and 12 seconds, which can also be described as 0.51753 of a day. The function can use any speed unit and any unit of power although, the original ITTC documentation uses Knots and kWh respectively.</p>
<p>The process for estimating the current and the true speed through water is described below.</p>
<section id="step-1-estimate-the-speed-power-curve" class="level3" data-number="2.1">
<h3 data-number="2.1" class="anchored" data-anchor-id="step-1-estimate-the-speed-power-curve"><span class="header-section-number">2.1</span> Step 1: Estimate the speed-power curve</h3>
<p>Using the known speed over ground (<span class="math inline">\(V_g\)</span>) values and observed power (<span class="math inline">\(P_{obs}(V_s)\)</span>) values for each power/speed setting, find the coefficients of the equation</p>
<p><span class="math display">\[P(V_s) =a+ bV_s^q\]</span></p>
<p>Where:</p>
<ul>
<li>P(V_s) = the engine power at speed V_s</li>
<li>a,b, q = unknown coefficients</li>
</ul>
</section>
<section id="step-2-estimate-speed-through-water-from-observed-power-and-speed-power-model" class="level3" data-number="2.2">
<h3 data-number="2.2" class="anchored" data-anchor-id="step-2-estimate-speed-through-water-from-observed-power-and-speed-power-model"><span class="header-section-number">2.2</span> Step 2: Estimate speed through water from observed power and speed-power model</h3>
<p>using the coefficients of the speed power mode and the observed power calculate and estimate of the necessary speed through water using</p>
<p><span class="math display">\[V_s = \sqrt[q]{\frac{P(V_s)-a}{b}}\]</span></p>
</section>
<section id="step-3-estimate-current-and-current-coefficients" class="level3" data-number="2.3">
<h3 data-number="2.3" class="anchored" data-anchor-id="step-3-estimate-current-and-current-coefficients"><span class="header-section-number">2.3</span> Step 3: Estimate Current and current coefficients</h3>
<p>Using <span class="math inline">\(V_c = V_G - V_s\)</span>, get an estimate of <span class="math inline">\(V_c\)</span> for each speed setting and use it to find the coefficients of the following equation using leasts-squares</p>
<p><span class="math display">\[V_c = V_{C,C}\textrm{cos}(\frac{2\pi}{T_c}t) + V_{C,S}\textrm{sin}(\frac{2\pi}{T_c}t) + V_{C,T}t + V_{C,0}\]</span></p>
<p>Where:</p>
<ul>
<li>V_c = the current speed in knots</li>
<li>T_c = is the period of variation of current speed, it is measured in hours</li>
<li>t = the time for each run relative to the first run, it is measured in hours.</li>
<li><span class="math inline">\(V_{C,C}, V_{C,S}, V_{C,T}, V_{C,0} =\)</span> are unknown factors which found through iteration</li>
</ul>
<p>Once the coefficients have been calculated the value of <span class="math inline">\(V_c\)</span> can be updated</p>
</section>
<section id="step-4-re-calculate-the-speed-power-curve-coefficients" class="level3" data-number="2.4">
<h3 data-number="2.4" class="anchored" data-anchor-id="step-4-re-calculate-the-speed-power-curve-coefficients"><span class="header-section-number">2.4</span> Step 4: Re-calculate the speed-power curve coefficients</h3>
<p>Using the updated value of <span class="math inline">\(V_c\)</span> update the value of <span class="math inline">\(V_s\)</span> and re-calculate the parameters a.b and q for the speed power curve.</p>
<p>Using the new speed power curve and the estimated values of <span class="math inline">\(V_s\)</span> create the predicted values of engine power.</p>
</section>
<section id="step-5-measure-the-error-between-the-observed-and-predicted-enginer-power" class="level3" data-number="2.5">
<h3 data-number="2.5" class="anchored" data-anchor-id="step-5-measure-the-error-between-the-observed-and-predicted-enginer-power"><span class="header-section-number">2.5</span> Step 5: Measure the error between the observed and predicted Enginer power</h3>
<p>Using the equation</p>
<p><span class="math display">\[SSE =\sum (P_{pred}(V_s)-P_{obs}(V_s))^2\]</span></p>
<p>measure the sum square error of the estimates. if the error is larger than tolerance go to Step 2, otherwise if the process has converged and the error minimised, finish and return the final values of <span class="math inline">\(V_c\)</span> and <span class="math inline">\(V_s\)</span></p>
<p>When setting the tolerance any small value is acceptable. typically a tolerance of <span class="math inline">\(10^{-6}\)</span> is used however values as large as <span class="math inline">\(10^{-2}\)</span> would probably have negligable impact on the final analysis</p>
</section>
<section id="diagram" class="level3" data-number="2.6">
<h3 data-number="2.6" class="anchored" data-anchor-id="diagram"><span class="header-section-number">2.6</span> Diagram</h3>
<p>The below diagram provides a schematic of the process described above</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">graph LR;
  A(SOG) --&gt; B(Step 1)
  Z(Power) --&gt;B
  B --&gt; C(Step 2)
  C --&gt; D(Step 3)
  D --&gt; E(Step 4)
  E --&gt; L{Convergence?}
  L -- No --&gt; C
  L -- Yes --&gt; M[Return STW]
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
<section id="note" class="level3" data-number="2.7">
<h3 data-number="2.7" class="anchored" data-anchor-id="note"><span class="header-section-number">2.7</span> Note:</h3>
<p>This algorithm is not guarenteed to converge, nor is it guarenteed to reduce the square error each iteration. As such the function returns the current and power law parameters which produced the lowest error. It also returns a dataframe containing the error for each iteration</p>
<p><strong>ITTC equations:</strong> H-1 to H-5</p>
<p>This equation is not vectorised</p>
<hr>
<p><a href="https://github.com/JonnoB/pyseatrials/blob/main/pyseatrials/current.py#L13" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="estimate_speed_through_water" class="level3" data-number="2.8">
<h3 data-number="2.8" class="anchored" data-anchor-id="estimate_speed_through_water"><span class="header-section-number">2.8</span> estimate_speed_through_water</h3>
<blockquote class="blockquote">
<pre><code> estimate_speed_through_water (power:float, sog:float, t:float, T_c:float,
                               tolerance:float=1, max_iter:float=1000,
                               p0:list=[0, 1, 3], bounds:tuple=([0, 0,
                               2.5], [5000, 20, 3.5]))</code></pre>
</blockquote>
<table class="caption-top table">
<colgroup>
<col style="width: 6%">
<col style="width: 25%">
<col style="width: 34%">
<col style="width: 34%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Default</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>power</td>
<td>float</td>
<td></td>
<td>The engine power, typically the ‘ideal condition’ is used [W]</td>
</tr>
<tr class="even">
<td>sog</td>
<td>float</td>
<td></td>
<td>Speed over ground of the vessel [m/s]</td>
</tr>
<tr class="odd">
<td>t</td>
<td>float</td>
<td></td>
<td>Time difference from current run to first run [hours]</td>
</tr>
<tr class="even">
<td>T_c</td>
<td>float</td>
<td></td>
<td>Time duration period of the tide typically 12.42 hours [hours]</td>
</tr>
<tr class="odd">
<td>tolerance</td>
<td>float</td>
<td>1</td>
<td>The process terminates when the error falls below the specified threshold in Watts</td>
</tr>
<tr class="even">
<td>max_iter</td>
<td>float</td>
<td>1000</td>
<td>Max imum number of iterations before process terminates</td>
</tr>
<tr class="odd">
<td>p0</td>
<td>list</td>
<td>[0, 1, 3]</td>
<td>the initial guess for the power law coefficients they represent the expeonents a + bX^c [None]</td>
</tr>
<tr class="even">
<td>bounds</td>
<td>tuple</td>
<td>([0, 0, 2.5], [5000, 20, 3.5])</td>
<td>Bounds the power law equation to within realistic values</td>
</tr>
<tr class="odd">
<td><strong>Returns</strong></td>
<td><strong>tuple</strong></td>
<td></td>
<td><strong>Outputs a tuple of the stw, current, current coefficients, and speed power coefficints that minimised the error. Also returns a dataframe or the error per iteration</strong></td>
</tr>
</tbody>
</table>
<p>To help gain an intuitive understanding of the concept of the semidiurnal current, an example is plotted below. Not that the last terms in the current model (i.e.&nbsp;‘<span class="math inline">\(V_{C,T}t + V_{C,0}\)</span>’) has no periodic component. This means that the iterative method can produce increasingly incorrect results over longer periods.</p>
<div id="cell-8" class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>T_c <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>V_c_C<span class="op">=-</span><span class="dv">2</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>V_c_S<span class="op">=-</span><span class="dv">2</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>V_c_T<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>V_c_0<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>times <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">24</span>, <span class="dv">200</span>)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>current_speed <span class="op">=</span> V_c_C <span class="op">*</span> np.cos((<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">/</span> T_c) <span class="op">*</span> times) <span class="op">+</span> V_c_S <span class="op">*</span> np.sin((<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">/</span> T_c) <span class="op">*</span> times) <span class="op">+</span> V_c_T <span class="op">*</span> times <span class="op">+</span> V_c_0</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>plt.plot(times, current_speed)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time (hours)'</span>)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Current speed'</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Current speed over 24 hours using the iterative method'</span>)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_current_files/figure-html/cell-3-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The example below demonstrates the process of identifying current speed using speed overground and the current equation. It should be noted that this method is an estimate only and as can be seen by the example can still produce a significant error.</p>
<div id="cell-10" class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>T_c <span class="op">=</span> <span class="dv">12</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>V_c_C<span class="op">=-</span><span class="dv">2</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>V_c_S<span class="op">=-</span><span class="dv">2</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>V_c_T<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>V_c_0<span class="op">=</span><span class="fl">0.1</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>t <span class="op">=</span> np.array([<span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>])  <span class="co"># Time values relative to the first run</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>sog <span class="op">=</span> np.array([<span class="dv">5</span>, <span class="dv">10</span>, <span class="dv">15</span>, <span class="dv">20</span>, <span class="dv">25</span>])</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>V_c_true <span class="op">=</span> V_c_C <span class="op">*</span> np.cos((<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">/</span> T_c) <span class="op">*</span> t) <span class="op">+</span> V_c_S <span class="op">*</span> np.sin((<span class="dv">2</span> <span class="op">*</span> np.pi <span class="op">/</span> T_c) <span class="op">*</span> t) <span class="op">+</span> V_c_T <span class="op">*</span> t <span class="op">+</span> V_c_0</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>V_s_true <span class="op">=</span> V_c_true <span class="op">+</span> sog</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>a_true <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>b_true <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>c_true <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>power <span class="op">=</span> a_true <span class="op">+</span> b_true <span class="op">*</span> V_s_true <span class="op">**</span> c_true</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>stw, current_speed, _, _, error_df <span class="op">=</span> estimate_speed_through_water(power, sog, t, T_c)</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Estimated speed through water:"</span>, stw)</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"The error on the estimated speed through water is: "</span><span class="op">+</span><span class="bu">str</span>(stw<span class="op">-</span>V_s_true) )</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>plt.plot(t, V_s_true)</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>plt.scatter(t, stw, color <span class="op">=</span> <span class="st">'red'</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time (hours)'</span>)</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Speed Through Water'</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'True STW (blue) and estimated STW (red)'</span>)</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Estimated speed through water: [ 3.36403099  7.8889879  13.11458325 19.03103214 25.44343601]
The error on the estimated speed through water is: [0.26403099 0.42103871 0.54663406 0.63103214 0.67548682]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_current_files/figure-html/cell-4-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The error on the calculation can also be visualised.</p>
<div id="cell-12" class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>plt.plot(error_df[<span class="st">'Iteration'</span>], error_df[<span class="st">'Power_Error'</span>])</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Iteration'</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Sum of squared errors'</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Change in error per iteration'</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_current_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="mean-of-means-method" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="mean-of-means-method"><span class="header-section-number">3</span> Mean of means method</h2>
<p>Another approach to finding the current</p>
<p><span class="math display">\[V_s = \frac{V_{G1} + 3V_{G2}+ 3V_{G3} + V_{G4}}{8}\]</span></p>
<p>Where <span class="math inline">\(V_s\)</span> is the speed through water and <span class="math inline">\(V_{G1}\)</span> to <span class="math inline">\(V_{G4}\)</span> are the mean speed over-ground for each double run at a given speed.</p>
<p>The current is assumed to have a parabolic form and as such can be expressed as</p>
<p><span class="math display">\[V_c = V_{C,2} t^2 + V_{C,1} t +V_{C,1}\]</span></p>
<p>Where <span class="math inline">\(V_c\)</span> is the current speed, and <span class="math inline">\(V_{C,2}\)</span>, <span class="math inline">\(V_{C,1}\)</span>, <span class="math inline">\(V_{C,0}\)</span> are unknown factors.</p>
<p>The solution to the current equation can therefore be found by treating it as a system of linear equations of the form <span class="math inline">\(y = X\beta\)</span>. The system of linear equations is shown below.</p>
<p><span class="math display">\[\begin{bmatrix}
    V_{G1} - V_s  \\
    V_{G2} - V_s  \\
    V_{G3} - V_s \\
    V_{G4} - V_s  \\
\end{bmatrix}
=
\begin{bmatrix}
    (t + 3\Delta t)^2 &amp; -(t + 3\Delta t) &amp; 1 \\
    (t + \Delta t)^2 &amp; -(t + \Delta t) &amp; 1 \\
    (t - \Delta t)^2 &amp; -(t - \Delta t) &amp; 1 \\
    (t - 3\Delta t)^2 &amp; -(t - 3\Delta t) &amp; 1 \\
\end{bmatrix}
\cdot
\begin{bmatrix}
    V_{C,2}\\
    V_{C,1} \\
    V_{C,0} \\
\end{bmatrix} \]</span></p>
<p>This equation demonstrates the need to perform two double runs, i.e.&nbsp;4 runs as this will result in four equations with the 3 uknowns of <span class="math inline">\(V_{C,2}\)</span>, <span class="math inline">\(V_{C,1}\)</span>, <span class="math inline">\(V_{C,0}\)</span>. It should be noted that as current is not a parabola the values found should be used for interpolation not extrapolation. Setting the example below to 24 hours will produce terrifying torrents, which are obviously not realistic.</p>
<p><strong>ITTC equations:</strong> H-6 to H-11</p>
<p>This equation is not vectorised</p>
<hr>
<p><a href="https://github.com/JonnoB/pyseatrials/blob/main/pyseatrials/current.py#L92" target="_blank" style="float:right; font-size:smaller">source</a></p>
<section id="current_mean_of_means" class="level3" data-number="3.1">
<h3 data-number="3.1" class="anchored" data-anchor-id="current_mean_of_means"><span class="header-section-number">3.1</span> current_mean_of_means</h3>
<blockquote class="blockquote">
<pre><code> current_mean_of_means (sog:numpy.ndarray, start_time:float,
                        time_between_runs:float)</code></pre>
</blockquote>
<table class="caption-top table">
<colgroup>
<col style="width: 9%">
<col style="width: 38%">
<col style="width: 52%">
</colgroup>
<thead>
<tr class="header">
<th></th>
<th><strong>Type</strong></th>
<th><strong>Details</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>sog</td>
<td>ndarray</td>
<td>The mean speed over ground across a double run,</td>
</tr>
<tr class="even">
<td>start_time</td>
<td>float</td>
<td>Time in decimal hours when the first run took place,</td>
</tr>
<tr class="odd">
<td>time_between_runs</td>
<td>float</td>
<td>Time in decimal hours between each run. Note the time difference must be consistent between all runs</td>
</tr>
<tr class="even">
<td><strong>Returns</strong></td>
<td><strong>float</strong></td>
<td><strong>Outputs a tuple of the stw vector, the current vector and the coefficients</strong></td>
</tr>
</tbody>
</table>
<div id="cell-15" class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>sog <span class="op">=</span> np.array([<span class="dv">10</span>, <span class="fl">12.6</span>, <span class="fl">12.6</span>, <span class="dv">11</span>])  <span class="co"># Mean speed over ground across a double run</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>start_time <span class="op">=</span> <span class="fl">0.0</span>  <span class="co"># Time in decimal hours when the first run took place</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>time_between_runs <span class="op">=</span> <span class="dv">1</span>  <span class="co"># Time in decimal hours between each run</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>stw, current, coefs<span class="op">=</span> current_mean_of_means(sog, start_time, time_between_runs)</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Current speed m/s:"</span>, current)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Current speed m/s: [-0.525 -0.405 -0.525 -0.885]</code></pre>
</div>
</div>
<div id="cell-16" class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> quadratic_function(t, coeffs):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    a, b, c <span class="op">=</span> coeffs</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> a <span class="op">*</span> t<span class="op">**</span><span class="dv">2</span> <span class="op">+</span> b <span class="op">*</span> t <span class="op">+</span> c</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the current speed throughout the day</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>times <span class="op">=</span> np.linspace(<span class="dv">0</span>, <span class="dv">4</span>, <span class="dv">100</span>)  </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>current_strength <span class="op">=</span> quadratic_function(times, coefs) </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the current speed over the 24-hour period</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>plt.plot(times, current_strength)</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Time (hours)'</span>)</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Current speed'</span>)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Current speed over four hours using the mean of means method'</span>)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="06_current_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-17" class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> nbdev<span class="op">;</span> nbdev.nbdev_export()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/JonnoB\.github\.io\/pyseatrials");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/JonnoB/pyseatrials/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>